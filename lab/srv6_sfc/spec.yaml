nodes:
  - name: R1
    image: slankdev/ubuntu:18.04
    interfaces:
      - { name: net0, type: bridge, args: SW }
  - name: R2
    image: slankdev/ubuntu:18.04
    interfaces:
      - { name: net0, type: bridge, args: SW }
  - name: R3
    image: slankdev/ubuntu:18.04
    interfaces:
      - { name: net0, type: bridge, args: SW }
  - name: R4
    image: slankdev/ubuntu:18.04
    interfaces:
      - { name: net0, type: bridge, args: SW }

switches:
  - name: SW
    interfaces:
      - { name: net0, type: docker, args: R1 }
      - { name: net0, type: docker, args: R2 }
      - { name: net0, type: docker, args: R3 }
      - { name: net0, type: docker, args: R4 }

node_configs:
  - name: R1
    cmds:
      - cmd: bash -c "enable_seg6_router.py | sh"
      - cmd: echo "----------------------------------------"
      - cmd: ip addr add cafe:1::1/64 dev net0
      - cmd: ip addr add fd00:1::1/64 dev lo

      - cmd: ip route add fd00:2::/64 via cafe:1::2
      - cmd: ip route add fd00:3::/64 via cafe:1::3
      - cmd: ip route add fd00:4::1 encap seg6 mode encap segs fd00:2::1,fd00:3::1 dev net0

  - name: R2
    cmds:
      - cmd: bash -c "enable_seg6_router.py | sh"
      - cmd: echo "----------------------------------------"
      - cmd: ip addr add cafe:1::2/64 dev net0
      - cmd: ip addr add fd00:2::1/64 dev lo
    
      - cmd: ip route add fd00:3::/64 via cafe:1::3
      - cmd: ip route add fd00:4::/64 via cafe:1::4
      - cmd: ip route add fd00:2::1/64 encap seg6local action End dev net0

  - name: R3
    cmds:
      - cmd: bash -c "enable_seg6_router.py | sh"
      - cmd: echo "----------------------------------------"
      - cmd: ip addr add cafe:1::3/64 dev net0
      - cmd: ip addr add fd00:3::1/64 dev lo

      - cmd: ip route add fd00:2::/64 via cafe:1::2
      - cmd: ip route add fd00:4::/64 via cafe:1::4
      - cmd: ip route add fd00:3::1/64 encap seg6local action End dev net0

  - name: R4
    cmds:
      - cmd: bash -c "enable_seg6_router.py | sh"
      - cmd: echo "----------------------------------------"
      - cmd: ip addr add cafe:1::4/64 dev net0
      - cmd: ip addr add fd00:4::1/64 dev lo

      #- cmd: ip route add fd00:4::1/64 encap seg6local action End dev net3


test:
  - name: R3
    cmds:
      - cmd: docker exec R1 ip route del fd00:4::1
      - cmd: docker exec R1 ip route add fd00:4::1 encap seg6 mode encap segs fd00:3::1 dev net0
  - name: R2
    cmds:
      - cmd: docker exec R1 ip route del fd00:4::1
      - cmd: docker exec R1 ip route add fd00:4::1 encap seg6 mode encap segs fd00:2::1 dev net0
  - name: R2R3
    cmds:
      - cmd: docker exec R1 ip route del fd00:4::1
      - cmd: docker exec R1 ip route add fd00:4::1 encap seg6 mode encap segs fd00:2::1,fd00:3::1 dev net0
  - name: tc
    cmds:
      - cmd: docker exec R3 tc qdisc add dev net0 root handle 1:0 tbf rate 50mbit burst 25kb limit 250kb




# root@R4:/# iperf -s -V
# root@R1:/# iperf -c fd00:4::1 -V