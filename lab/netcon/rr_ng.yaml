# [問題①]
# RR1 or RR2 で "sh ip bgp neighbors 11.11.11.11 routes" 
# 同じルート情報を受け取っていてルーティングテーブルを圧迫している．
# この重複を解決せよ！
# [解答]
# RR1とRR2でcluster-idが揃っていない．
# そのため，お互いに別のところからもらってきたルート情報だと勘違いして重複したルート情報をAdvertiseしてしまっている．
# cluster-idを明示的に揃えてあげればOK！
# [問題②]
# R4とRR1，RR2の間でeBGPピアは張れるのに経路情報が交換されない．なぜ！？
# [解答]
# ebgpポリシーを設定していない状態ではeBGPピアで経路情報を交換しないようになっている．(RFC？？？)            
# "no bgp ebgp-requires-polic" 設定を追加すればOK!
nodes:
    - name: R1
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: direct, args: RR1#net0 }
        - { name: net1, type: direct, args: RR2#net0 }
    - name: R2
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: direct, args: RR1#net1 }
        - { name: net1, type: direct, args: RR2#net1 }
    - name: R3
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: direct, args: RR1#net2 }
        - { name: net1, type: direct, args: RR2#net2 }
    - name: R4
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: bridge, args: Bridge0 }
    - name: RR1
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: direct, args: R1#net0 }
        - { name: net1, type: direct, args: R2#net0 }
        - { name: net2, type: direct, args: R3#net0 }
        - { name: net3, type: direct, args: RR2#net3 }
        - { name: net4, type: bridge, args: Bridge0 }
    - name: RR2
      image: yykzm/frr:v7.5.1
      interfaces:
        - { name: net0, type: direct, args: R1#net1 }
        - { name: net1, type: direct, args: R2#net1 }
        - { name: net2, type: direct, args: R3#net1 }
        - { name: net3, type: direct, args: RR1#net3 }
        - { name: net4, type: bridge, args: Bridge0 }
switches:
  - name: Bridge0
    interfaces:
      - {name: net4, type: docker, args: RR1 }
      - {name: net4, type: docker, args: RR2 }
      - {name: net0, type: docker, args: R4 }

node_configs:
    - name: R1
      cmds:
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 1.1.1.1/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.1.1.1/24'
            -c 'exit'
            -c 'interface net1'
            -c ' ip address 10.2.1.1/24'
            -c 'exit'
            -c 'router ospf'
            -c ' network 1.1.1.1/32 area 0.0.0.0'
            -c ' network 10.1.1.0/24 area 0.0.0.0'
            -c ' network 10.2.1.0/24 area 0.0.0.0'
            -c 'exit'
            -c 'router bgp 65002'
            -c ' bgp router-id 1.1.1.1'
            -c ' neighbor 11.11.11.11 remote-as 65002'
            -c ' neighbor 11.11.11.11 update-source lo'
            -c ' neighbor 22.22.22.22 remote-as 65002'
            -c ' neighbor 22.22.22.22 update-source lo'
            -c ' address-family ipv4 unicast'
            -c '  redistribute connected'
            -c ' exit-address-family'
            -c 'exit'
    - name: R2
      cmds:
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 2.2.2.2/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.1.2.1/24'
            -c 'exit'
            -c 'interface net1'
            -c ' ip address 10.2.2.1/24'
            -c 'exit'
            -c 'router ospf'
            -c ' network 2.2.2.2/32 area 0.0.0.0'
            -c ' network 10.1.2.0/24 area 0.0.0.0'
            -c ' network 10.2.2.0/24 area 0.0.0.0'
            -c 'exit'
            -c 'router bgp 65002'
            -c ' bgp router-id 2.2.2.2'
            -c ' neighbor 11.11.11.11 remote-as 65002'
            -c ' neighbor 11.11.11.11 update-source lo'
            -c ' neighbor 22.22.22.22 remote-as 65002'
            -c ' neighbor 22.22.22.22 update-source lo'
            -c ' address-family ipv4 unicast'
            -c '  redistribute connected'
            -c ' exit-address-family'
            -c 'exit'
    - name: R3
      cmds:
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 3.3.3.3/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.1.3.1/24'
            -c 'exit'
            -c 'interface net1'
            -c ' ip address 10.2.3.1/24'
            -c 'exit'
            -c 'router ospf'
            -c ' network 3.3.3.3/32 area 0.0.0.0'
            -c ' network 10.1.3.0/24 area 0.0.0.0'
            -c ' network 10.2.3.0/24 area 0.0.0.0'
            -c 'exit'
            -c 'router bgp 65002'
            -c ' bgp router-id 3.3.3.3'
            -c ' neighbor 11.11.11.11 remote-as 65002'
            -c ' neighbor 11.11.11.11 update-source lo'
            -c ' neighbor 22.22.22.22 remote-as 65002'
            -c ' neighbor 22.22.22.22 update-source lo'
            -c ' address-family ipv4 unicast'
            -c '  redistribute connected'
            -c ' exit-address-family'
            -c 'exit'
    - name: R4
      cmds:
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 4.4.4.4/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.255.1.3/24'
            -c 'exit'
            -c 'ip route 11.11.11.11/32 10.255.1.1'
            -c 'ip route 22.22.22.22/32 10.255.1.2'
            -c 'router bgp 65001'
            -c ' bgp router-id 4.4.4.4'
            -c ' neighbor 11.11.11.11 remote-as 65002'
            -c ' neighbor 11.11.11.11 update-source lo'
            -c ' neighbor 11.11.11.11 ebgp-multihop 2'
            -c ' neighbor 22.22.22.22 remote-as 65002'
            -c ' neighbor 22.22.22.22 update-source lo'
            -c ' neighbor 22.22.22.22 ebgp-multihop 2'
            -c ' address-family ipv4 unicast'
            -c '  redistribute connected'
            -c ' exit-address-family'
            -c 'exit'
    - name: RR1
      cmds:
        - cmd: tcpdump -nni net3 -w /tmp/RR1-net3.pcap &
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 11.11.11.11/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.1.1.2/24'
            -c 'exit'
            -c 'interface net1'
            -c ' ip address 10.1.2.2/24'
            -c 'exit'
            -c 'interface net2'
            -c ' ip address 10.1.3.2/24'
            -c 'exit'
            -c 'interface net3'
            -c ' ip address 10.255.3.1/24'
            -c 'exit'
            -c 'interface net4'
            -c ' ip address 10.255.1.1/24'
            -c 'exit'
            -c 'ip route 4.4.4.4/32 10.255.1.3'
            -c 'router ospf'
            -c ' network 11.11.11.11/32 area 0.0.0.0'
            -c ' network 10.1.1.0/24 area 0.0.0.0'
            -c ' network 10.1.2.0/24 area 0.0.0.0'
            -c ' network 10.1.3.0/24 area 0.0.0.0'
            -c ' network 10.255.3.0/24 area 0.0.0.0'
            -c ' redistribute static' 
            -c 'exit'
            -c 'router bgp 65002'
            -c ' no bgp ebgp-requires-polic'
            -c ' bgp cluster-id 12.12.12.12'
            -c ' bgp router-id 11.11.11.11'
            -c ' neighbor 1.1.1.1 remote-as 65002'
            -c ' neighbor 1.1.1.1 update-source lo'
            -c ' neighbor 2.2.2.2 remote-as 65002'
            -c ' neighbor 2.2.2.2 update-source lo'
            -c ' neighbor 3.3.3.3 remote-as 65002'
            -c ' neighbor 3.3.3.3 update-source lo'
            -c ' neighbor 22.22.22.22 remote-as 65002'
            -c ' neighbor 22.22.22.22 update-source lo'
            -c ' neighbor 4.4.4.4 remote-as 65001'
            -c ' neighbor 4.4.4.4 update-source lo'
            -c ' address-family ipv4 unicast'
            -c '  neighbor 1.1.1.1 route-reflector-client'
            -c '  neighbor 1.1.1.1 next-hop-self'
            -c '  neighbor 2.2.2.2 route-reflector-client'
            -c '  neighbor 2.2.2.2 next-hop-self'
            -c '  neighbor 3.3.3.3 route-reflector-client'
            -c '  neighbor 3.3.3.3 next-hop-self'
            -c ' exit-address-family'
            -c 'exit'
    - name: RR2
      cmds:
        - cmd: tcpdump -nni net3 -w /tmp/RR2-net3.pcap &
        - cmd: cp /etc/frr/vtysh.conf.sample /etc/frr/vtysh.conf
        - cmd: /usr/lib/frr/frr start
        - cmd: sysctl -w net.ipv4.ip_forward=1
        - cmd: sysctl -w net.ipv4.conf.all.rp_filter=0
        - cmd: >-
            vtysh -c 'conf t'
            -c 'interface lo'
            -c ' ip address 22.22.22.22/32'
            -c 'exit'
            -c 'interface net0'
            -c ' ip address 10.2.1.2/24'
            -c 'exit'
            -c 'interface net1'
            -c ' ip address 10.2.2.2/24'
            -c 'exit'
            -c 'interface net2'
            -c ' ip address 10.2.3.2/24'
            -c 'exit'
            -c 'interface net3'
            -c ' ip address 10.255.3.2/24'
            -c 'exit'
            -c 'interface net4'
            -c ' ip address 10.255.1.2/24'
            -c 'exit'
            -c 'ip route 4.4.4.4/32 10.255.1.3'
            -c 'router ospf'
            -c ' network 22.22.22.22/32 area 0.0.0.0'
            -c ' network 10.2.1.0/24 area 0.0.0.0'
            -c ' network 10.2.2.0/24 area 0.0.0.0'
            -c ' network 10.2.3.0/24 area 0.0.0.0'
            -c ' network 10.255.3.0/24 area 0.0.0.0'
            -c ' redistribute static'
            -c 'exit'
            -c 'router bgp 65002'
            -c ' no bgp ebgp-requires-polic'
            -c ' bgp cluster-id 12.12.12.12'
            -c ' bgp router-id 22.22.22.22'
            -c ' neighbor 1.1.1.1 remote-as 65002'
            -c ' neighbor 1.1.1.1 update-source lo'
            -c ' neighbor 2.2.2.2 remote-as 65002'
            -c ' neighbor 2.2.2.2 update-source lo'
            -c ' neighbor 3.3.3.3 remote-as 65002'
            -c ' neighbor 3.3.3.3 update-source lo'
            -c ' neighbor 11.11.11.11 remote-as 65002'
            -c ' neighbor 11.11.11.11 update-source lo'
            -c ' neighbor 4.4.4.4 remote-as 65001'
            -c ' neighbor 4.4.4.4 update-source lo'
            -c ' address-family ipv4 unicast'
            -c '  neighbor 1.1.1.1 route-reflector-client'
            -c '  neighbor 1.1.1.1 next-hop-self'
            -c '  neighbor 2.2.2.2 route-reflector-client'
            -c '  neighbor 2.2.2.2 next-hop-self'
            -c '  neighbor 3.3.3.3 route-reflector-client'
            -c '  neighbor 3.3.3.3 next-hop-self'
            -c ' exit-address-family'
            -c 'exit'

test:
    - name: link
      cmds:
        - cmd: docker exec R1 ping -c2 10.1.1.2
        - cmd: docker exec R1 ping -c2 10.2.1.2
        - cmd: docker exec R2 ping -c2 10.1.2.2
        - cmd: docker exec R2 ping -c2 10.2.2.2
        - cmd: docker exec R3 ping -c2 10.1.3.2
        - cmd: docker exec R3 ping -c2 10.2.3.2
        - cmd: docker exec R4 ping -c2 10.255.1.1
        - cmd: docker exec R4 ping -c2 10.255.1.2
        - cmd: docker exec RR1 ping -c2 10.1.1.1
        - cmd: docker exec RR1 ping -c2 10.1.2.1
        - cmd: docker exec RR1 ping -c2 10.1.3.1
        - cmd: docker exec RR1 ping -c2 10.255.1.2
        - cmd: docker exec RR1 ping -c2 10.255.1.3
        - cmd: docker exec RR1 ping -c2 10.255.3.2
        - cmd: docker exec RR2 ping -c2 10.2.1.1
        - cmd: docker exec RR2 ping -c2 10.2.2.1
        - cmd: docker exec RR2 ping -c2 10.2.3.1
        - cmd: docker exec RR2 ping -c2 10.255.1.1
        - cmd: docker exec RR2 ping -c2 10.255.1.3
        - cmd: docker exec RR2 ping -c2 10.255.3.1





